<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/blog/ie.html"><![endif]--> <title>Extjs5-Ext.form.field.Tag初始化数据实现filter加载</title> <meta name="description" content="公司后台管理系统是Extjs5开发的,应业务需求需要,要实现combobox多选功能,Extjs5本身功能很强大,肯定已经有这样的组件Ext.form.field.Tag,运行人家的Demo,觉得很炫酷."> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/blog/css/main.css"> <link rel="canonical" href="http://yzhengfei.github.io/blog/2015/10/14/Extjs5-Ext.form.field.Tag%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0filter%E5%8A%A0%E8%BD%BD.html"> <link rel="alternate" type="application/rss+xml" title="Welcome | 尹正飞的博客" href="http://yzhengfei.github.io/blog/feed.xml" /> <script src="/blog/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/blog/"> <img id="sidebar-avatar-img" alt="" src="/blog/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/blog/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:657812595@qq.com" class="sidebar-social-icon email"></a> <a href="https://github.com/yzhengfei" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="微信营销打假">微信营销打假</li> <li class="sidebar-tag" data-filter="Linux命令">Linux命令</li> <li class="sidebar-tag" data-filter="Extjs5">Extjs5</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="Extjs5" href="/blog/2015/10/14/Extjs5-Ext.form.field.Tag%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0filter%E5%8A%A0%E8%BD%BD.html"> Extjs5-Ext.form.field.Tag初始化数据实现filter加载 </a> <a class="toc-link" data-tags="Linux命令" href="/blog/2015/10/12/Linux%E5%91%BD%E4%BB%A4-MySql%20binlog%E5%88%86%E6%9E%90%E7%A4%BA%E4%BE%8B.html"> Linux命令-MySql binlog分析示例 </a> <a class="toc-link" data-tags="微信营销打假" href="/blog/2015/09/26/%E5%BE%AE%E4%BF%A1%E8%90%A5%E9%94%80%E6%89%93%E5%81%87-%E5%91%A8%E5%A4%A7%E7%A6%8F%E9%9B%86%E6%9C%88%E9%A5%BC.html"> 微信营销打假-周大福集月饼 </a> <a class="toc-link" data-tags="微信营销打假" href="/blog/2015/08/25/%E5%BE%AE%E4%BF%A1%E8%90%A5%E9%94%80%E6%89%93%E5%81%87-%E8%BD%A6%E8%BD%AE%E8%80%83%E9%A9%BE%E7%85%A7%E9%9B%86%E5%AD%97%E9%80%81%E5%AD%A6%E9%A9%BE%E7%85%A7%E8%B4%B9%E7%94%A8.html"> 微信营销打假-车轮考驾照集字送学驾照费用 </a> </nav> </div> </aside> <main id="main"> <div class="post container"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2015 October 14</span> <span class="post-meta-span tag">Extjs5</span> </div> <h1 class="post-title">Extjs5-Ext.form.field.Tag初始化数据实现filter加载</h1> <p>公司后台管理系统是Extjs5开发的,应业务需求需要,要实现combobox多选功能,Extjs5本身功能很强大,肯定已经有这样的组件<a href="http://docs.sencha.com/extjs/5.1/5.1.1-apidocs/#!/api/Ext.form.field.Tag">Ext.form.field.Tag</a>,运行人家的Demo,觉得很炫酷. <img src="/blog/assets/img/2015-10-13/2015-10-13%2016:16:26.png" alt="Extjs Demo"></p> <p>自己运行了一下,感觉自己掉进坑里了,如果有默认值的话,会死循环从服务器加载数据,刚开始觉得自己调用方式有问题,弄了半天,发现还是不行,网上搜搜基本上没有好的解决方法,想了想还是自己看人家的源码吧,功夫不负有心人,居然让我给找到了. <img src="/blog/assets/img/2015-10-13/2015-10-13%2016:26:45.png" alt="Extjs源码"></p> <p>setValue这个方法中处理从远程加载数据及重复加载问题,解决方式请看下图注释,已详细解释 <img src="/blog/assets/img/2015-10-13/2015-10-13%2016:52:14.png" alt="死循环处理"></p> <p>回到帖子主题,Extjs默认从服务器加载不存在的记录时候是通过valueParam这个参数控制的(例如:valueParam=ids,那么请求的参数为ids=1,2,3,4,5),但是我的服务端是已经写好了,不想再增加这个参数操作,想直接通过filter参数格式加载,怎么办,请看下图 <img src="/blog/assets/img/2015-10-13/2015-10-13%2016:33:45.png" alt="filter请求更改"></p> <p>快来看看效果吧 <img src="/blog/assets/img/2015-10-13/2015-10-13%2016:34:45.png" alt="快来看看效果吧"></p> <p>重写Ext.form.field.Tag的代码</p> <div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Ext</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;Overrides.form.field.Tag&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">override</span><span class="o">:</span> <span class="s1">&#39;Ext.form.field.Tag&#39;</span><span class="p">,</span>

    <span class="nx">setValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="cm">/* private */</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">skipLoad</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
            <span class="nx">valueStore</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">valueStore</span><span class="p">,</span>
            <span class="nx">valueField</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">valueField</span><span class="p">,</span>
            <span class="nx">unknownValues</span> <span class="o">=</span> <span class="p">[],</span>
            <span class="nx">store</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">store</span><span class="p">,</span>
            <span class="nx">record</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">valueRecord</span><span class="p">,</span> <span class="nx">cls</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">isNumber</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">Ext</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">Ext</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">me</span><span class="p">.</span><span class="nx">multiSelect</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">delimiter</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">value</span> <span class="o">=</span> <span class="nx">Ext</span><span class="p">.</span><span class="nb">Array</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">record</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">record</span> <span class="o">||</span> <span class="o">!</span><span class="nx">record</span><span class="p">.</span><span class="nx">isModel</span><span class="p">)</span> <span class="p">{</span>

                <span class="cm">/**</span>
<span class="cm">                 * 此组件默认是对字符串处理,我这边只对数字做了处理,Extjs还支持boolean/date,各位根据自己的需求自己实现</span>
<span class="cm">                 * 至于为什么要做转换,是由于此组件的findRecord方法中,Store根据字段名和字段值获取这条记录这个方法导致的</span>
<span class="cm">                 *  var matches = this.getStore().queryRecords(field, value);</span>
<span class="cm">                 * Tag组件字段类型是字符串,split后肯定也是字符串,如果field的字段类型是int,那么通过queryRecords是获取不到</span>
<span class="cm">                 * 此记录的,就算值一样(类型不一样,例如:1==&#39;1&#39;),我觉得这是Extjs的一个bug吧</span>
<span class="cm">                 */</span>
                <span class="c1">//检测是否是数字处理</span>
                <span class="nx">isNumber</span> <span class="o">=</span> <span class="nx">Ext</span><span class="p">.</span><span class="nb">Number</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">isNumber</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span>
                    <span class="nx">record</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isNumber</span><span class="p">;</span>
                <span class="c1">//检测是否是Boolean处理</span>
                <span class="c1">//......</span>
                <span class="c1">//检测是否是date处理</span>
                <span class="c1">//......</span>

                <span class="nx">valueRecord</span> <span class="o">=</span> <span class="nx">valueStore</span><span class="p">.</span><span class="nx">findExact</span><span class="p">(</span><span class="nx">valueField</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">valueRecord</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">valueStore</span><span class="p">.</span><span class="nx">getAt</span><span class="p">(</span><span class="nx">valueRecord</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">valueRecord</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">findRecord</span><span class="p">(</span><span class="nx">valueField</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">valueRecord</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">forceSelection</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">unknownValues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">record</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">valueRecord</span> <span class="o">=</span> <span class="p">{};</span>
                            <span class="nx">valueRecord</span><span class="p">[</span><span class="nx">me</span><span class="p">.</span><span class="nx">valueField</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>
                            <span class="nx">valueRecord</span><span class="p">[</span><span class="nx">me</span><span class="p">.</span><span class="nx">displayField</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>

                            <span class="nx">cls</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">valueStore</span><span class="p">.</span><span class="nx">getModel</span><span class="p">();</span>
                            <span class="nx">valueRecord</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cls</span><span class="p">(</span><span class="nx">valueRecord</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">valueRecord</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">valueRecord</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">store</span><span class="p">.</span><span class="nx">isEmptyStore</span> <span class="o">&amp;&amp;</span> <span class="nx">skipLoad</span> <span class="o">!==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">unknownValues</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">me</span><span class="p">.</span><span class="nx">queryMode</span> <span class="o">===</span> <span class="s1">&#39;remote&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="cm">/**</span>
<span class="cm">             * 我的应用走的标准的Extjs MVVM,为了统一风格,将此传参方式改为Filter形式</span>
<span class="cm">             */</span>
            <span class="nx">params</span><span class="p">[</span><span class="nx">me</span><span class="p">.</span><span class="nx">valueParam</span> <span class="o">||</span> <span class="nx">me</span><span class="p">.</span><span class="nx">valueField</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Ext</span><span class="p">.</span><span class="nx">encode</span><span class="p">([{</span>
                <span class="nx">property</span><span class="o">:</span> <span class="nx">me</span><span class="p">.</span><span class="nx">valueField</span><span class="p">,</span>
                <span class="nx">value</span><span class="o">:</span> <span class="nx">unknownValues</span><span class="p">,</span>
                <span class="nx">operator</span><span class="o">:</span> <span class="s1">&#39;in&#39;</span>
            <span class="p">}]);</span>
            <span class="nx">store</span><span class="p">.</span><span class="nx">load</span><span class="p">({</span>
                <span class="nx">params</span><span class="o">:</span> <span class="nx">params</span><span class="p">,</span>
                <span class="nx">callback</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">itemList</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">me</span><span class="p">.</span><span class="nx">itemList</span><span class="p">.</span><span class="nx">unmask</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">autoSize</span><span class="p">();</span>
                    <span class="nx">me</span><span class="p">.</span><span class="nx">lastQuery</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// For single-select boxes, use the last good (formal record) value if possible</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">multiSelect</span> <span class="o">&amp;&amp;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">isModel</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">Ext</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">me</span><span class="p">.</span><span class="nx">callSuper</span><span class="p">([</span><span class="nx">value</span><span class="p">,</span> <span class="nx">add</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://yzhengfei.github.io/blog/2015/10/14/Extjs5-Ext.form.field.Tag%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0filter%E5%8A%A0%E8%BD%BD.html&text=Extjs5-Ext.form.field.Tag初始化数据实现filter加载" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://yzhengfei.github.io/blog/2015/10/14/Extjs5-Ext.form.field.Tag%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0filter%E5%8A%A0%E8%BD%BD.html&title=Extjs5-Ext.form.field.Tag初始化数据实现filter加载" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://yzhengfei.github.io/blog/2015/10/14/Extjs5-Ext.form.field.Tag%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%AE%9E%E7%8E%B0filter%E5%8A%A0%E8%BD%BD.html&title=Extjs5-Ext.form.field.Tag初始化数据实现filter加载" target="_blank" class="post-share-icon weibo"></a> </div> </div> </div> <!-- <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> --> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/blog/assets/js/jquery-2.1.3.min.js"></script> <script src="/blog/assets/js/jquery.pjax.js"></script> <script src="/blog/assets/js/nprogress.js"></script> <script src="/blog/assets/js/main.js"></script> <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "//hm.baidu.com/hm.js?60c42d56356d1300d9cb60ae39b0a5a4"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script> </body> </html>
